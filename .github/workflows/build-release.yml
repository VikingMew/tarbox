name: Build Release Binaries

on:
  # 只允许手动触发
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v0.1.0)"
        required: false
        default: "dev"
      target:
        description: "Build target (all, linux-x86, linux-arm, macos-arm)"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - linux-x86
          - linux-arm
          - macos-arm

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'linux-x86' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.92"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fuse3 libfuse3-dev pkg-config

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --verbose

      - name: Strip binary
        run: strip target/release/tarbox

      - name: Create tarball
        run: |
          cd target/release
          tar -czf tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz tarbox
          sha256sum tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz > tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarbox-linux-x86_64
          path: |
            target/release/tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz
            target/release/tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz.sha256

  build-macos:
    name: Build macOS ARM (Apple Silicon)
    runs-on: macos-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'macos-arm' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.92"
          targets: aarch64-apple-darwin

      - name: Install macFUSE
        run: |
          brew install --cask macfuse

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-aarch64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-aarch64-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-aarch64-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target aarch64-apple-darwin --verbose

      - name: Strip binary
        run: strip target/aarch64-apple-darwin/release/tarbox

      - name: Create tarball
        run: |
          cd target/aarch64-apple-darwin/release
          tar -czf tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz tarbox
          shasum -a 256 tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz > tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarbox-aarch64-apple-darwin
          path: |
            target/aarch64-apple-darwin/release/tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz
            target/aarch64-apple-darwin/release/tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz.sha256

  build-linux-arm:
    name: Build Linux ARM64
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'linux-arm' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.92"
          targets: aarch64-unknown-linux-gnu

      - name: Install ARM64 cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-aarch64-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-aarch64-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-aarch64-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary
        run: cargo build --release --target aarch64-unknown-linux-gnu --verbose
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Strip binary
        run: aarch64-linux-gnu-strip target/aarch64-unknown-linux-gnu/release/tarbox

      - name: Create tarball
        run: |
          cd target/aarch64-unknown-linux-gnu/release
          tar -czf tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz tarbox
          sha256sum tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz > tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarbox-linux-aarch64
          path: |
            target/aarch64-unknown-linux-gnu/release/tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz
            target/aarch64-unknown-linux-gnu/release/tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz.sha256

  build-linux-musl:
    name: Build Linux x86_64 (musl, static)
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.target == 'all' || github.event.inputs.target == 'linux-x86' }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: "1.92"
          targets: x86_64-unknown-linux-musl

      - name: Install musl tools
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-musl-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-musl-cargo-git-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache target directory
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-musl-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release binary (musl)
        run: cargo build --release --target x86_64-unknown-linux-musl --verbose
        env:
          RUSTFLAGS: "-C target-feature=+crt-static"

      - name: Strip binary
        run: strip target/x86_64-unknown-linux-musl/release/tarbox

      - name: Create tarball
        run: |
          cd target/x86_64-unknown-linux-musl/release
          tar -czf tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz tarbox
          sha256sum tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz > tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tarbox-linux-x86_64-musl
          path: |
            target/x86_64-unknown-linux-musl/release/tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz
            target/x86_64-unknown-linux-musl/release/tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz.sha256

  create-release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [build-linux, build-macos, build-linux-arm, build-linux-musl]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create release summary
        run: |
          echo "# Tarbox Release Build Summary" > release-summary.md
          echo "" >> release-summary.md
          echo "**Version:** ${{ github.event.inputs.version }}" >> release-summary.md
          echo "**Build Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> release-summary.md
          echo "**Commit:** ${{ github.sha }}" >> release-summary.md
          echo "" >> release-summary.md
          echo "## Built Artifacts" >> release-summary.md
          echo "" >> release-summary.md

          find artifacts -type f -name "*.tar.gz" -o -name "*.zip" | while read file; do
            filename=$(basename "$file")
            size=$(du -h "$file" | cut -f1)
            echo "- \`$filename\` ($size)" >> release-summary.md

            # Find corresponding sha256 file
            sha256file="${file}.sha256"
            if [ -f "$sha256file" ]; then
              sha256=$(cat "$sha256file" | awk '{print $1}')
              echo "  - SHA256: \`$sha256\`" >> release-summary.md
            fi
          done

          echo "" >> release-summary.md
          echo "## Installation" >> release-summary.md
          echo "" >> release-summary.md
          echo "### Linux x86_64 (glibc)" >> release-summary.md
          echo "\`\`\`bash" >> release-summary.md
          echo "tar -xzf tarbox-${{ github.event.inputs.version }}-linux-x86_64.tar.gz" >> release-summary.md
          echo "sudo mv tarbox /usr/local/bin/" >> release-summary.md
          echo "\`\`\`" >> release-summary.md
          echo "" >> release-summary.md
          echo "### Linux x86_64 (musl, static)" >> release-summary.md
          echo "\`\`\`bash" >> release-summary.md
          echo "tar -xzf tarbox-${{ github.event.inputs.version }}-linux-x86_64-musl.tar.gz" >> release-summary.md
          echo "sudo mv tarbox /usr/local/bin/" >> release-summary.md
          echo "\`\`\`" >> release-summary.md
          echo "" >> release-summary.md
          echo "### Linux ARM64 (aarch64)" >> release-summary.md
          echo "\`\`\`bash" >> release-summary.md
          echo "tar -xzf tarbox-${{ github.event.inputs.version }}-linux-aarch64.tar.gz" >> release-summary.md
          echo "sudo mv tarbox /usr/local/bin/" >> release-summary.md
          echo "\`\`\`" >> release-summary.md
          echo "" >> release-summary.md
          echo "### macOS (Apple Silicon)" >> release-summary.md
          echo "\`\`\`bash" >> release-summary.md
          echo "tar -xzf tarbox-${{ github.event.inputs.version }}-aarch64-apple-darwin.tar.gz" >> release-summary.md
          echo "sudo mv tarbox /usr/local/bin/" >> release-summary.md
          echo "\`\`\`" >> release-summary.md

          cat release-summary.md

      - name: Upload release summary
        uses: actions/upload-artifact@v4
        with:
          name: release-summary
          path: release-summary.md
