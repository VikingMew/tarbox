# Task 07: 文件系统核心高级功能

## 目标

实现文件系统核心逻辑，包括路径解析、文件操作、目录管理、权限控制等 POSIX 文件系统基础功能。

## 优先级

**P0 - 最高优先级**

## 依赖

- Task 01: 项目初始化和基础设施搭建
- Task 02: 数据库存储层实现

## 子任务

### 3.1 路径解析

- [ ] 实现路径解析器
  - `resolve_path()` - 将路径解析为 inode
  - 支持绝对路径和相对路径
  - 处理 `.` 和 `..`
  - 处理符号链接
  - 检测循环引用

- [ ] 实现路径缓存
  - LRU 缓存路径到 inode 的映射
  - 缓存失效机制
  - 缓存命中率统计

- [ ] 路径验证
  - 检查路径长度限制
  - 检查文件名合法性
  - 处理多租户路径隔离

### 3.2 文件操作

- [ ] 实现文件创建
  - `create_file()` - 创建普通文件
  - 分配 inode
  - 设置默认权限
  - 记录审计日志

- [ ] 实现文件打开
  - `open_file()` - 打开文件
  - 检查权限（读/写/执行）
  - 分配文件句柄
  - 支持打开标志（O_RDONLY, O_WRONLY, O_RDWR, O_CREAT, O_TRUNC 等）

- [ ] 实现文件读取
  - `read_file()` - 读取文件内容
  - 支持偏移量和大小
  - 自动检测文件类型（文本/二进制）
  - 文本文件从 text_blocks 重组
  - 二进制文件从 data_blocks 读取
  - 更新访问时间

- [ ] 实现文件写入
  - `write_file()` - 写入文件内容
  - 支持偏移量写入
  - 支持追加写入
  - 自动检测文本文件
  - 文本文件计算 diff 并存储
  - 二进制文件按块存储
  - 更新修改时间
  - 记录审计日志

- [ ] 实现文件删除
  - `unlink_file()` - 删除文件
  - 减少硬链接计数
  - nlinks=0 时标记删除
  - 异步清理数据块
  - 记录审计日志

- [ ] 实现文件截断
  - `truncate_file()` - 截断文件
  - 删除多余的数据块
  - 更新文件大小

### 3.3 目录操作

- [ ] 实现目录创建
  - `create_directory()` - 创建目录
  - 创建目录 inode
  - 自动添加 `.` 和 `..` 条目
  - 支持递归创建（mkdir -p）

- [ ] 实现目录读取
  - `read_directory()` - 读取目录内容
  - 返回目录项列表
  - 支持排序（按名称、时间等）
  - 支持分页

- [ ] 实现目录删除
  - `remove_directory()` - 删除目录
  - 检查目录是否为空
  - 递归删除（如果指定）

- [ ] 实现文件/目录重命名
  - `rename()` - 重命名/移动
  - 处理同目录重命名
  - 处理跨目录移动
  - 原子操作保证
  - 记录审计日志

### 3.4 链接操作

- [ ] 实现硬链接
  - `create_hardlink()` - 创建硬链接
  - 增加 inode 的 nlinks 计数
  - 共享相同的数据块
  - 不支持目录硬链接

- [ ] 实现符号链接
  - `create_symlink()` - 创建符号链接
  - 存储目标路径
  - 支持相对和绝对路径

- [ ] 实现符号链接读取
  - `read_symlink()` - 读取符号链接目标
  - 返回目标路径字符串

### 3.5 权限管理

- [ ] 实现权限检查
  - `check_permission()` - 检查访问权限
  - 支持用户/组/其他权限
  - 支持读/写/执行权限
  - 考虑 setuid/setgid

- [ ] 实现权限修改
  - `chmod()` - 修改权限
  - 验证调用者权限
  - 更新 inode mode 字段
  - 记录审计日志

- [ ] 实现所有者修改
  - `chown()` - 修改所有者
  - 验证调用者权限（需要 root 或所有者）
  - 更新 uid/gid
  - 记录审计日志

### 3.6 元数据操作

- [ ] 实现获取文件属性
  - `stat()` - 获取文件属性
  - 返回 POSIX stat 结构
  - 包含大小、权限、时间戳等

- [ ] 实现修改时间
  - `utime()` - 修改访问和修改时间
  - 支持设置为当前时间或指定时间

- [ ] 实现扩展属性（可选）
  - `setxattr()` - 设置扩展属性
  - `getxattr()` - 获取扩展属性
  - `listxattr()` - 列出扩展属性
  - `removexattr()` - 删除扩展属性

### 3.7 文件类型检测

- [ ] 实现文件类型自动检测
  - 检查文件扩展名
  - 检测 UTF-8 编码
  - 检测是否包含行结构
  - 设置文件类型标记

- [ ] 实现文本文件处理
  - 解析行
  - 检测行结束符（LF/CRLF/CR）
  - 检测编码
  - 限制最大行数和文件大小

### 3.8 缓存管理

- [ ] 实现元数据缓存
  - Inode 缓存
  - 目录内容缓存
  - 路径缓存
  - LRU 淘汰策略

- [ ] 实现数据块缓存
  - 二进制数据块缓存
  - 文本块缓存
  - 重组结果缓存
  - 缓存一致性保证

- [ ] 实现缓存失效
  - 写入时更新缓存
  - 删除时清除缓存
  - 支持手动刷新

### 3.9 并发控制

- [ ] 实现文件锁
  - 读写锁支持
  - 文件级锁
  - 字节范围锁（可选）

- [ ] 实现并发安全
  - 使用 Tokio 的异步锁
  - 避免死锁
  - 正确处理并发写入

### 3.10 错误处理

- [ ] 定义文件系统错误类型
  - ENOENT (文件不存在)
  - EEXIST (文件已存在)
  - EACCES (权限拒绝)
  - EISDIR (是目录)
  - ENOTDIR (不是目录)
  - ENOTEMPTY (目录非空)
  - 等标准 errno

- [ ] 实现错误映射
  - 数据库错误 -> 文件系统错误
  - 保留错误上下文

### 3.11 测试

- [ ] 单元测试
  - 每个文件系统操作的测试
  - 权限检查测试
  - 路径解析测试
  - 错误处理测试

- [ ] 集成测试
  - 完整的文件操作流程
  - 目录树操作
  - 并发操作测试
  - 边界情况测试

- [ ] 性能测试
  - 文件创建/读写/删除性能
  - 大目录列表性能
  - 深层目录路径解析性能
  - 并发操作性能

## 验收标准

- [ ] 支持基本的 POSIX 文件操作
- [ ] 路径解析正确处理各种情况
- [ ] 权限检查正确工作
- [ ] 文本文件和二进制文件正确区分和处理
- [ ] 并发操作安全
- [ ] 所有测试通过
- [ ] 性能满足目标要求

## 预估时间

7-10 天

## 技术要点

- 使用 async/await 异步编程
- 正确处理 UTF-8 编码
- 文本文件使用 similar crate 计算 diff
- 二进制文件使用 blake3 计算哈希
- 使用 moka 实现缓存
- 注意多租户隔离

## 注意事项

- 所有操作必须带 tenant_id
- 路径必须规范化（去除 `..` 等）
- 文件名长度限制（255 字节）
- 路径总长度限制（4096 字节）
- 注意符号链接的循环引用检测
- 文本文件超过阈值要降级为二进制处理
- 缓存大小要可配置
- 审计日志要异步写入

## 后续任务

完成后可以开始：
- Task 04: FUSE 接口实现
- Task 05: 分层文件系统实现
