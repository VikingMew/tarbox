# Task 07: 文件系统核心高级功能

## 目标

实现高级文件系统功能，包括：
- **符号链接和硬链接**: 完整的 POSIX 链接支持
- **扩展属性**: 用户自定义元数据存储
- **文件锁**: 并发控制和访问同步
- **权限和 ACL**: 高级权限管理
- **缓存层**: 提升性能的多级缓存

## 优先级

**P1 - 高优先级**

## 依赖

- Task 01: 项目初始化和基础设施搭建 ✅
- Task 02: 数据库存储层 MVP ✅
- Task 03: 文件系统核心 MVP ✅
- Task 05: FUSE 接口 ✅
- Task 06: 数据库层高级功能（需要扩展属性的数据库支持）

## 依赖的Spec

- **spec/02-fuse-interface.md** - POSIX 操作映射（symlink, link, xattr, flock）
- **spec/07-performance.md** - 缓存策略、性能优化指南（核心）
- **spec/14-filesystem-interface.md** - FilesystemInterface 抽象层
- spec/01-database-schema.md - inodes 表结构（link_target, nlinks, xattrs 字段）
- spec/10-text-file-optimization.md - 文本文件的特殊处理

## 子任务

### 7.1 符号链接实现

- [ ] 数据库支持
  - 使用 `inodes.link_target` 字段存储目标路径
  - 支持相对路径和绝对路径

- [ ] 核心操作
  - `create_symlink()` - 创建符号链接
  - `read_symlink()` - 读取符号链接目标
  - 路径解析时自动跟随符号链接
  - 检测和防止循环引用

- [ ] FUSE 集成
  - 实现 `symlink()` 回调
  - 实现 `readlink()` 回调
  - 正确设置文件类型为 S_IFLNK

### 7.2 硬链接实现

- [ ] 数据库支持
  - 使用 `inodes.nlinks` 计数硬链接数
  - 多个目录项指向同一 inode

- [ ] 核心操作
  - `create_hardlink()` - 创建硬链接
  - 增加 nlinks 计数
  - 删除文件时减少 nlinks
  - nlinks=0 时真正删除 inode 和数据

- [ ] FUSE 集成
  - 实现 `link()` 回调
  - 正确维护 nlinks 计数

- [ ] 限制
  - 不支持目录硬链接
  - 不支持跨租户硬链接

### 7.3 扩展属性实现

- [ ] 数据库支持
  - 使用 `inodes.xattrs` JSONB 字段存储扩展属性
  - 键值对存储

- [ ] 核心操作
  - `setxattr()` - 设置扩展属性
  - `getxattr()` - 获取扩展属性值
  - `listxattr()` - 列出所有属性键
  - `removexattr()` - 删除扩展属性

- [ ] FUSE 集成
  - 实现 `setxattr()` 回调
  - 实现 `getxattr()` 回调
  - 实现 `listxattr()` 回调
  - 实现 `removexattr()` 回调

- [ ] 验证和限制
  - 属性名称格式验证
  - 属性值大小限制
  - 单个文件扩展属性数量限制

### 7.4 文件锁实现

- [ ] 锁机制设计
  - 内存中维护锁表
  - 支持共享锁（读锁）
  - 支持排他锁（写锁）
  - 文件级锁定

- [ ] 核心操作
  - `lock_file()` - 获取文件锁
  - `unlock_file()` - 释放文件锁
  - `try_lock_file()` - 非阻塞获取锁
  - 检测死锁

- [ ] FUSE 集成
  - 实现 `flock()` 回调
  - 实现 `setlk()` / `getlk()` 回调

- [ ] 并发控制
  - 使用 Tokio 异步锁
  - 锁超时机制
  - 进程退出时自动释放锁

### 7.5 高级路径解析

- [ ] 符号链接跟随
  - 在路径解析过程中自动跟随符号链接
  - 支持多级符号链接
  - 限制跟随深度（防止循环）
  - 检测循环引用

- [ ] 性能优化
  - 缓存符号链接解析结果
  - 批量路径解析优化

### 7.6 文件类型检测增强

- [ ] 自动检测优化
  - 更准确的文本/二进制检测
  - 支持更多文本编码
  - 检测特殊文件类型（脚本、配置文件等）

- [ ] 文本文件阈值
  - 最大文件大小阈值
  - 最大行长度阈值
  - 超过阈值降级为二进制处理

### 7.7 缓存优化

- [ ] 元数据缓存增强
  - 符号链接目标缓存
  - 扩展属性缓存
  - 硬链接信息缓存

- [ ] 缓存失效策略
  - 符号链接修改时失效
  - 硬链接修改时失效
  - 扩展属性修改时失效

### 7.8 错误处理增强

- [ ] 新增错误类型
  - ELOOP - 符号链接循环
  - EMLINK - 硬链接过多
  - ENOATTR - 扩展属性不存在
  - EWOULDBLOCK - 文件锁冲突

- [ ] 错误恢复
  - 符号链接损坏处理
  - 锁异常释放

### 7.9 测试

- [ ] 符号链接测试
  - 创建和读取符号链接
  - 跟随符号链接
  - 循环引用检测
  - 损坏的符号链接处理

- [ ] 硬链接测试
  - 创建硬链接
  - nlinks 计数正确性
  - 删除硬链接
  - 多个硬链接指向同一数据

- [ ] 扩展属性测试
  - 设置和获取扩展属性
  - 列出扩展属性
  - 删除扩展属性
  - 限制和验证

- [ ] 文件锁测试
  - 获取和释放锁
  - 锁冲突处理
  - 并发锁测试
  - 死锁检测

- [ ] 集成测试
  - 符号链接 + 权限
  - 硬链接 + 文本文件优化
  - 扩展属性 + 审计日志
  - 文件锁 + 并发写入

- [ ] 性能测试
  - 深层符号链接解析性能
  - 大量硬链接性能
  - 扩展属性读写性能
  - 锁争用性能

## 不在本任务范围内

以下功能不在本任务范围内：

### 字节范围锁
- fcntl() 字节范围锁定
- **实现位置**: 性能优化任务

### 直接 I/O
- O_DIRECT 标志支持
- **实现位置**: 性能优化任务

### 特殊文件类型
- 块设备、字符设备
- FIFO 管道
- Socket 文件
- **实现位置**: 完整 POSIX 兼容性任务

### ACL (访问控制列表)
- POSIX ACL 支持
- **实现位置**: 企业级安全功能任务

## 验收标准

- [ ] 符号链接正确工作（创建、读取、跟随）
- [ ] 硬链接正确工作（创建、删除、nlinks 计数）
- [ ] 扩展属性正确工作（设置、获取、列出、删除）
- [ ] 文件锁正确工作（获取、释放、冲突处理）
- [ ] 符号链接循环检测正常工作
- [ ] 可以使用标准工具测试（ln -s, ln, setfattr, getfattr, flock 等）
- [ ] 所有测试通过
- [ ] 性能满足目标要求
- [ ] 并发操作安全

## 预估时间

5-7 天

## 技术要点

- 使用 `inodes.link_target` 存储符号链接目标
- 使用 `inodes.nlinks` 计数硬链接
- 使用 `inodes.xattrs` JSONB 存储扩展属性
- 路径解析时限制符号链接跟随深度（如 40）
- 文件锁使用内存数据结构，无需持久化
- 使用 async Mutex 实现锁
- 注意多租户隔离

## 注意事项

- 符号链接可以指向不存在的路径（损坏的符号链接）
- 硬链接必须指向存在的文件
- 不支持目录硬链接
- 扩展属性键名需要验证（如 user.*, system.* 等命名空间）
- 文件锁是进程级的，进程退出后自动释放
- 符号链接循环检测要高效（避免无限递归）
- 所有操作必须带 tenant_id，确保多租户隔离

## 后续任务

完成后可以开始：
- 分层文件系统实现
- 审计系统实现
- 性能优化任务
