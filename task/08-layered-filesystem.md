# Task 05: 分层文件系统实现

## 目标

实现类似 Docker 镜像层的分层文件系统，支持写时复制（COW）、检查点创建、层间切换、历史回溯等功能。

## 优先级

**P1 - 高优先级**

## 依赖

- Task 01: 项目初始化和基础设施搭建
- Task 02: 数据库存储层实现
- Task 03: 基础文件系统实现
- Task 04: FUSE 接口实现

## 子任务

### 5.1 层管理基础

- [ ] 实现层数据结构
  - Layer 结构定义
  - 层链表示（parent_layer_id）
  - 层状态管理（只读/可写）

- [ ] 实现基础层（Base Layer）
  - 创建租户时自动创建基础层
  - 基础层的特殊处理（无父层）
  - 基础层数据初始化

- [ ] 实现当前层管理
  - 维护每个租户的当前活跃层
  - 获取当前层
  - 设置当前层

### 5.2 检查点（Checkpoint）操作

- [ ] 实现创建检查点
  - `create_checkpoint()` - 创建新检查点
  - 将当前层标记为只读
  - 创建新的可写层
  - 设置父子关系
  - 记录层元数据
  - 记录审计日志

- [ ] 实现检查点命名
  - 支持用户自定义名称
  - 自动生成时间戳名称
  - 名称唯一性检查

- [ ] 实现检查点描述
  - 存储检查点描述信息
  - 支持标签和注释

### 5.3 层间切换

- [ ] 实现切换到历史层
  - `switch_to_layer()` - 切换到指定层
  - 检查未保存的修改
  - 切换当前层指针
  - 清除缓存
  - 更新文件系统视图

- [ ] 实现非破坏性切换
  - 切换到历史层时不删除未来层
  - 保留完整的历史链
  - 允许切换回来

- [ ] 实现在历史层创建新层
  - 检测到在历史层有修改时
  - 提示用户确认
  - 创建新层（删除未来层）
  - 更新层链结构

### 5.4 写时复制（COW）实现

- [ ] 实现二进制文件 COW
  - 检测文件修改
  - 如果文件在父层，复制 inode
  - 创建新的数据块
  - 使用内容寻址去重
  - 更新层条目

- [ ] 实现文本文件 COW
  - 检测文本文件修改
  - 计算与父层的 diff
  - 只存储变化的行
  - 创建新的 text_blocks
  - 更新 text_line_map
  - 复用未修改的 TextBlock

- [ ] 实现目录 COW
  - 目录结构修改的处理
  - 只复制修改的目录项
  - 保持目录树一致性

### 5.5 联合视图（Union View）

- [ ] 实现文件查找
  - 从当前层开始向上查找
  - 返回最近层的版本
  - 处理删除标记

- [ ] 实现目录合并
  - 合并多层的目录内容
  - 去重（同名文件取最新层）
  - 处理删除标记

- [ ] 实现层链遍历
  - 高效的层链查询
  - 缓存层链信息
  - 避免重复数据库查询

### 5.6 层操作

- [ ] 实现列出所有层
  - `list_layers()` - 列出租户的所有层
  - 按时间排序
  - 显示层关系（树形或链表）
  - 显示层统计信息

- [ ] 实现查看层详情
  - `get_layer_info()` - 获取层详细信息
  - 文件变化统计
  - 层大小
  - 创建时间和描述

- [ ] 实现查看层差异
  - `get_layer_changes()` - 获取层的变化
  - 列出新增的文件
  - 列出修改的文件
  - 列出删除的文件

### 5.7 层删除

- [ ] 实现删除层
  - `delete_layer()` - 删除指定层
  - 验证是否可删除（不能删除有子层的层）
  - 清理层数据
  - 减少数据块引用计数
  - 清理无引用的数据块

- [ ] 实现批量删除
  - 删除多个连续的层
  - 验证层链完整性
  - 原子操作保证

### 5.8 层合并（Squash）

- [ ] 实现层压缩
  - `squash_layers()` - 合并多个层
  - 验证层的连续性
  - 合并层的变化
  - 创建新的合并层
  - 优化存储（去除中间状态）

- [ ] 实现智能合并
  - 检测同文件的多次修改
  - 只保留最终状态
  - 检测添加后删除的文件（完全移除）

### 5.9 文件历史

- [ ] 实现文件历史查询
  - `get_file_history()` - 查询文件在各层的版本
  - 返回每层的文件信息
  - 显示修改时间和大小
  - 显示变化统计（对于文本文件）

- [ ] 实现文件版本对比
  - `diff_file_between_layers()` - 对比两层的文件
  - 文本文件显示行级 diff
  - 二进制文件显示字节级差异

- [ ] 实现文件恢复
  - 从历史层恢复文件
  - 复制指定层的文件到当前层

### 5.10 层数据管理

- [ ] 实现层条目管理
  - 记录每层变化的文件
  - 维护层条目索引
  - 高效查询层的所有条目

- [ ] 实现引用计数
  - 数据块引用计数
  - TextBlock 引用计数
  - 自动清理零引用数据

- [ ] 实现层统计
  - 计算层的实际大小
  - 统计文件数量
  - 计算去重率

### 5.11 文件系统 Hook 实现

- [ ] 实现虚拟目录 `/.tarbox/layers/`
  - 虚拟文件系统结构
  - 不存储到数据库
  - 动态生成内容

- [ ] 实现层控制接口
  - `/.tarbox/layers/current` - 显示当前层
  - `/.tarbox/layers/list` - 列出所有层
  - `/.tarbox/layers/new` - 创建新层（写入层名）
  - `/.tarbox/layers/switch` - 切换层（写入层 ID）
  - `/.tarbox/layers/diff` - 查看当前层差异

- [ ] 实现命令解析
  - 解析写入的命令
  - 执行相应操作
  - 返回结果（通过读取）

- [ ] 实现 snapshots 视图
  - `/.tarbox/snapshots/<layer-name>/` - 层的只读视图
  - 显示该层的完整文件树
  - 支持浏览和读取

### 5.12 性能优化

- [ ] 实现层链缓存
  - 缓存层的父子关系
  - 缓存层链路径
  - 减少数据库查询

- [ ] 实现增量查询
  - 只查询变化的部分
  - 避免全量扫描
  - 利用索引优化

- [ ] 实现延迟加载
  - 按需加载层数据
  - 分页加载大层
  - 流式处理

### 5.13 一致性保证

- [ ] 实现事务支持
  - 层操作使用事务
  - 确保原子性
  - 失败时回滚

- [ ] 实现数据完整性检查
  - 验证层链完整性
  - 检查数据块引用
  - 检测孤儿数据

- [ ] 实现并发控制
  - 避免并发创建层
  - 避免并发切换层
  - 使用锁保护关键操作

### 5.14 测试

- [ ] 单元测试
  - 测试每个层操作
  - 测试 COW 机制
  - 测试联合视图
  - 测试引用计数

- [ ] 集成测试
  - 测试完整的层操作流程
  - 测试层切换
  - 测试文件历史
  - 测试文件系统 Hook

- [ ] 性能测试
  - 层深度对性能的影响
  - COW 开销测试
  - 层切换性能
  - 文件历史查询性能

- [ ] 压力测试
  - 大量层的场景
  - 大量文件的场景
  - 频繁切换层

## 验收标准

- [ ] 可以创建检查点
- [ ] 可以切换到历史层
- [ ] COW 正确工作（文本和二进制）
- [ ] 联合视图正确显示文件
- [ ] 文件历史可以查询
- [ ] 文件系统 Hook 正常工作
- [ ] 层删除和合并正确
- [ ] 引用计数正确管理
- [ ] 所有测试通过
- [ ] 性能满足要求

## 预估时间

10-14 天

## 技术要点

- 线性历史模型（单向链表）
- 写时复制（块级和行级）
- 内容寻址去重
- 引用计数管理
- 文本文件使用 similar crate 计算 diff
- 虚拟文件系统实现

## 注意事项

- 层链只能是单向的（不支持分支）
- 切换到历史层不立即删除未来层
- 在历史层创建新层时需要用户确认
- 层删除要检查是否有子层
- 引用计数必须正确维护
- 文本文件和二进制文件的 COW 机制不同
- 虚拟文件系统不能持久化到数据库
- 层操作要使用事务保证一致性
- 考虑层深度限制（避免过深影响性能）

## 后续任务

完成后可以开始：
- Task 06: 审计系统实现
- Task 07: REST API 实现
- Task 08: Kubernetes CSI 驱动实现
