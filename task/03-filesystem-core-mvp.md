# Task 03: 基础文件系统实现（MVP）

## 目标

实现最小可用的文件系统核心逻辑，支持基础的 POSIX 文件操作。

## 优先级

**P0 - 最高优先级**

## 依赖

- Task 01: 项目初始化和基础设施搭建
- Task 02: 数据库存储层（MVP）

## 子任务

### 3.1 路径解析

- [ ] 实现 resolve_path()
  - 将路径字符串解析为 inode_id
  - 从根目录开始逐级查找
  - 处理 `/` 分隔符
  - 返回最终的 inode

- [ ] 路径规范化
  - 处理多余的 `/`（如 `//data/file`）
  - 处理尾部 `/`（如 `/data/`）
  - 拒绝空路径

- [ ] 路径验证
  - 检查路径长度限制（4096 字节）
  - 检查文件名长度限制（255 字节）
  - 拒绝包含 NULL 字符的路径

### 3.2 目录操作

- [ ] 实现 create_directory()
  - 解析父目录路径
  - 检查目录是否已存在
  - 创建目录 inode (type=dir)
  - 设置默认权限 0755

- [ ] 实现 list_directory()
  - 解析目录路径
  - 查询所有子 inode
  - 返回名称和类型列表

- [ ] 实现 remove_directory()
  - 检查目录是否为空
  - 删除目录 inode
  - 简单实现，不支持递归删除

### 3.3 文件操作

- [ ] 实现 create_file()
  - 解析父目录路径
  - 检查文件是否已存在
  - 创建文件 inode (type=file, size=0)
  - 设置默认权限 0644

- [ ] 实现 write_file()
  - 解析文件路径
  - 将数据分块（4KB）
  - 创建 data_blocks
  - 更新 inode.size
  - 简化实现：覆盖写入，不支持追加和偏移

- [ ] 实现 read_file()
  - 解析文件路径
  - 读取所有 data_blocks
  - 按 block_index 排序
  - 拼接返回完整内容

- [ ] 实现 delete_file()
  - 解析文件路径
  - 删除所有 data_blocks
  - 删除 inode

### 3.4 元数据操作

- [ ] 实现 stat()
  - 获取 inode 信息
  - 返回文件大小、权限、时间戳等

- [ ] 实现 chmod()
  - 修改 inode.mode
  - 简单实现，不检查权限

- [ ] 实现 chown()
  - 修改 inode.uid/gid
  - 简单实现，不检查权限

### 3.5 错误处理

- [ ] 定义常用错误
  - PathNotFound - 路径不存在
  - AlreadyExists - 文件已存在
  - NotDirectory - 不是目录
  - IsDirectory - 是目录
  - DirectoryNotEmpty - 目录非空

- [ ] 实现错误映射
  - 数据库错误 -> 文件系统错误
  - 使用 anyhow 传播错误

### 3.6 测试

- [ ] 路径解析测试
  - 单级路径 `/data`
  - 多级路径 `/data/files/test.txt`
  - 根路径 `/`

- [ ] 目录操作测试
  - 创建目录
  - 列出目录
  - 删除空目录

- [ ] 文件操作测试
  - 创建文件
  - 写入数据
  - 读取数据
  - 删除文件

- [ ] 错误场景测试
  - 路径不存在
  - 文件已存在
  - 删除非空目录

## 验收标准

- [ ] 可以创建和列出目录
- [ ] 可以创建、读写、删除文件
- [ ] 路径解析正确
- [ ] 错误处理正确
- [ ] 所有测试通过

## 预估时间

3-4 天

## 技术要点

- 所有操作必须带 tenant_id
- 路径解析从根 inode (inode_id=1) 开始
- 写入时自动分块，每块最大 4KB
- 使用 anyhow 进行错误处理

## 简化内容

MVP 阶段暂不实现：
- 符号链接和硬链接
- 文件权限检查（所有操作都允许）
- 缓存
- 并发控制
- 文件锁
- 扩展属性
- 追加写入和偏移写入
- 文件截断

## 后续任务

完成后可以开始：
- Task 04: CLI 工具实现
- Task 07: 文件系统核心完善（权限、链接、缓存）
